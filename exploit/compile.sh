#!/usr/bin/env bash
PAYLOAD=${1:-"/bin/sh"}

# Prepare payload injection
STRLEN=${#PAYLOAD}
STRLEN_LINE="#define STRLEN	$STRLEN"
PAYLOAD_LINE="#define STRING	\"$PAYLOAD\""

# Make the shellcode source
cp shellcode.template.S shellcode.S
sed -i "/\/\/ payload/a $STRLEN_LINE" shellcode.S
sed -i "/\/\/ payload/a $PAYLOAD_LINE" shellcode.S

# Compile the shellcode on the VM
rm -f shellcode.bin
scp shellcode.S toto@192.168.56.101:/home/toto/lab/shellcode.S
ssh toto@192.168.56.101 "cd /home/toto/lab && make clean && make"
scp toto@192.168.56.101:/home/toto/lab/shellcode.bin shellcode.bin

hexdump -C shellcode.bin